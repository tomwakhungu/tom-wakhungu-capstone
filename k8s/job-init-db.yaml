apiVersion: batch/v1
kind: Job
metadata:
  name: init-database
  namespace: tom-wakhungu
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: init-db
        image: mysql:8.0
        env:
        - name: MYSQL_HOST
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: host
        - name: MYSQL_DATABASE
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: database
        - name: MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: username
        - name: MYSQL_PWD
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: password
        command:
        - /bin/sh
        - -c
        - |
          mysql -h $MYSQL_HOST -u $MYSQL_USER $MYSQL_DATABASE <<'EOF'
          CREATE TABLE IF NOT EXISTS medicines (
              id INT AUTO_INCREMENT PRIMARY KEY,
              name VARCHAR(100),
              quantity INTEGER,
              expiry_date DATE,
              category VARCHAR(50)
          );
          
          INSERT INTO medicines (name, quantity, expiry_date, category) VALUES
          ('Paracetamol', 150, '2025-12-31', 'Painkillers'),
          ('Amoxicillin', 8, '2025-06-30', 'Antibiotics'),
          ('Vitamin C', 200, '2026-03-15', 'Vitamins'),
          ('Ibuprofen', 45, '2025-09-20', 'Painkillers'),
          ('Bandages', 5, '2027-01-10', 'Antiseptics');
          
          SELECT COUNT(*) as total_medicines FROM medicines;
          EOF